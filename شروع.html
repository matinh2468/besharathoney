<!doctype html>
<html lang="fa">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ú©Ù¾Ú†Ø§ â€” ØµÙØ­Ù‡ ØªØ£ÛŒÛŒØ¯</title>
  <style>
    :root{font-family: "Segoe UI", Tahoma, Arial, "Noto Sans", sans-serif}
    body{display:flex;align-items:center;justify-content:center;min-height:100vh;background:#f3f4f6;margin:0;padding:20px}
    .card{background:#fff;padding:28px;border-radius:12px;box-shadow:0 6px 24px rgba(16,24,40,0.08);width:420px;max-width:100%}
    h1{font-size:18px;margin:0 0 12px;text-align:center}
    .captcha-row{display:flex;gap:12px;align-items:center;justify-content:center;margin:12px 0}
    canvas{border-radius:8px;border:1px solid #e5e7eb}
    input[type=text]{width:100%;padding:10px;border-radius:8px;border:1px solid #d1d5db;font-size:15px}
    .controls{display:flex;gap:8px;margin-top:12px}
    button{padding:10px 12px;border-radius:8px;border:0;background:#111827;color:white;cursor:pointer}
    button.secondary{background:#e5e7eb;color:#111827}
    .msg{margin-top:12px;font-size:14px;text-align:center}
    .small{font-size:13px;color:#6b7280;margin-top:8px;text-align:center}
  </style>
</head>
<body>
  <div class="card" role="main">
    <h1>Ù„Ø·ÙØ§Ù‹ Ú©Ù¾Ú†Ø§ Ø±Ø§ Ø­Ù„ Ú©Ù†ÛŒØ¯</h1>
    <div class="captcha-row">
      <canvas id="captcha" width="220" height="70" aria-label="Ú©Ù¾Ú†Ø§"></canvas>
      <div style="flex:1;min-width:80px;display:flex;flex-direction:column;gap:8px">
        <button id="refreshBtn" class="secondary" aria-label="ØªÙˆÙ„ÛŒØ¯ Ú©Ù¾Ú†Ø§ Ø¬Ø¯ÛŒØ¯">ğŸ” ØªØ§Ø²Ù‡â€ŒØ³Ø§Ø²ÛŒ</button>
        <button id="audioBtn" class="secondary" aria-label="Ø´Ù†ÛŒØ¯Ù† Ú©Ù¾Ú†Ø§">ğŸ”Š Ø®ÙˆØ§Ù†Ø¯Ù†</button>
      </div>
    </div>

    <label for="captchaInput" class="sr-only">ÙˆØ±ÙˆØ¯ÛŒ Ú©Ù¾Ú†Ø§</label>
    <input id="captchaInput" type="text" placeholder="Ù…ØªÙ† Ú©Ù¾Ú†Ø§ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯" autocomplete="off" inputmode="text" />

    <div class="controls">
      <button id="verifyBtn">ØªØ£ÛŒÛŒØ¯</button>
      <button id="cancelBtn" class="secondary">Ù„ØºÙˆ</button>
    </div>

    <div id="message" class="msg" aria-live="polite"></div>
    <div class="small">ØªÙˆØ¬Ù‡: Ø§ÛŒÙ† Ú©Ù¾Ú†Ø§ÛŒ Ù†Ù…ÙˆÙ†Ù‡ Ø±ÙˆÛŒ Ø³Ù…Øª Ú©Ø§Ø±Ø¨Ø± Ø§Ø¬Ø±Ø§ Ù…ÛŒâ€ŒØ´ÙˆØ¯. Ø¨Ø±Ø§ÛŒ Ø§Ù…Ù†ÛŒØª ÙˆØ§Ù‚Ø¹ÛŒ Ø­ØªÙ…Ø§Ù‹ Ø¢Ù† Ø±Ø§ Ø³Ù…Øª Ø³Ø±ÙˆØ± Ù‡Ù… ØªØ£ÛŒÛŒØ¯ Ú©Ù†ÛŒØ¯.</div>
  </div>

  <script>
    // ----- ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ú©Ù¾Ú†Ø§ -----
    const LENGTH = 6; // ØªØ¹Ø¯Ø§Ø¯ Ú©Ø§Ø±Ø§Ú©ØªØ±Ù‡Ø§
    const CHARS = 'ABCDEFGHJKLMNPQRSTUVWXYZabcdefghjkmnpqrstuvwxyz23456789'; // Ø­Ø°Ù Ø¨Ø±Ø®ÛŒ Ú©Ø§Ø±Ø§Ú©ØªØ±Ù‡Ø§ÛŒ Ø´Ø¨ÛŒÙ‡

    const canvas = document.getElementById('captcha');
    const ctx = canvas.getContext('2d');
    const refreshBtn = document.getElementById('refreshBtn');
    const audioBtn = document.getElementById('audioBtn');
    const verifyBtn = document.getElementById('verifyBtn');
    const cancelBtn = document.getElementById('cancelBtn');
    const input = document.getElementById('captchaInput');
    const msg = document.getElementById('message');

    let currentCaptcha = '';

    function randInt(a,b){return Math.floor(Math.random()*(b-a+1))+a}
    function randChar(){return CHARS.charAt(randInt(0,CHARS.length-1));}

    function drawCaptcha(){
      currentCaptcha = Array.from({length: LENGTH}, randChar).join('');

      // background
      ctx.clearRect(0,0,canvas.width,canvas.height);
      ctx.fillStyle = '#f8fafc';
      ctx.fillRect(0,0,canvas.width,canvas.height);

      // add noise lines
      for(let i=0;i<6;i++){
        ctx.beginPath();
        ctx.moveTo(randInt(0,canvas.width), randInt(0,canvas.height));
        ctx.quadraticCurveTo(randInt(0,canvas.width), randInt(0,canvas.height), randInt(0,canvas.width), randInt(0,canvas.height));
        ctx.lineWidth = randInt(1,2);
        ctx.strokeStyle = `rgba(${randInt(40,120)},${randInt(40,120)},${randInt(40,120)},${Math.random()*0.6+0.2})`;
        ctx.stroke();
      }

      // draw characters with slight rotation and different fontsizes
      const gap = canvas.width / (LENGTH + 1);
      for(let i=0;i<currentCaptcha.length;i++){
        const ch = currentCaptcha[i];
        const x = gap*(i+0.7) + randInt(-6,6);
        const y = canvas.height/2 + randInt(8,16);
        const angle = (randInt(-25,25) * Math.PI) / 180;
        ctx.save();
        ctx.translate(x,y);
        ctx.rotate(angle);
        const fontSize = randInt(28,38);
        ctx.font = `${fontSize}px sans-serif`;
        ctx.fillStyle = `rgba(${randInt(20,60)},${randInt(20,60)},${randInt(20,60)},${Math.random()*0.9+0.1})`;
        ctx.fillText(ch, -fontSize/2, 0);
        ctx.restore();
      }

      // pepper noise dots
      for(let i=0;i<40;i++){
        ctx.fillStyle = `rgba(${randInt(30,200)},${randInt(30,200)},${randInt(30,200)},${Math.random()*0.6+0.1})`;
        ctx.fillRect(randInt(0,canvas.width), randInt(0,canvas.height), randInt(1,2), randInt(1,2));
      }

      // slight overlay lines
      ctx.beginPath();
      ctx.moveTo(0,randInt(0,canvas.height));
      ctx.lineTo(canvas.width, randInt(0,canvas.height));
      ctx.lineWidth = 1;
      ctx.strokeStyle = 'rgba(0,0,0,0.03)';
      ctx.stroke();

      // for debugging in dev: console.log(currentCaptcha);
    }

    // audio read for accessibility (simple TTS of characters spaced)
    function readCaptcha(){
      if(!('speechSynthesis' in window)) return alert('Ù…Ø±ÙˆØ±Ú¯Ø± Ø´Ù…Ø§ Ø§Ø² SpeechSynthesis Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù†Ù…ÛŒâ€ŒÚ©Ù†Ø¯');
      const utter = new SpeechSynthesisUtterance(currentCaptcha.split('').join(' '));
      utter.rate = 0.9;
      window.speechSynthesis.cancel();
      window.speechSynthesis.speak(utter);
    }

    function verify(){
      const val = input.value.trim();
      if(!val){
        setMessage('Ù„Ø·ÙØ§Ù‹ Ú©Ù¾Ú†Ø§ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯', 'error');
        return;
      }

      // Ø³Ù…Øª Ú©Ø§Ø±Ø¨Ø±: Ù…Ù‚Ø§ÛŒØ³Ù‡â€ŒÛŒ Ø³Ø§Ø¯Ù‡ØŒ Ø¨Ø¯ÙˆÙ† Ø­Ø³Ø§Ø³ÛŒØª Ø¨Ù‡ Ø­Ø±ÙˆÙ Ø¨Ø²Ø±Ú¯/Ú©ÙˆÚ†Ú©
      if(val.toLowerCase() === currentCaptcha.toLowerCase()){
        setMessage('Ú©Ù¾Ú†Ø§ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª ØªØ§ÛŒÛŒØ¯ Ø´Ø¯. Ø¯Ø± Ø­Ø§Ù„ Ø§Ù†ØªÙ‚Ø§Ù„...', 'success');
        // Ø§Ø¹Ù…Ø§Ù„ Ø¬Ø§Ù†Ø¨ÛŒ: Ø¨Ù‡ index Ù‡Ø¯Ø§ÛŒØª Ù…ÛŒâ€ŒÚ©Ù†Ø¯
        setTimeout(()=>{
          // Ø§Ú¯Ø± Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ù…Ø³ÛŒØ± Ø¯ÛŒÚ¯Ø±ÛŒ Ø¨Ø¯Ù‡ÛŒØ¯ØŒ Ø§ÛŒÙ† Ø¢Ø¯Ø±Ø³ Ø±Ø§ ØªØºÛŒÛŒØ± Ø¯Ù‡ÛŒØ¯
          window.location.href = 'index.html';
        }, 900);
      } else {
        setMessage('Ú©Ù¾Ú†Ø§ Ù†Ø§Ø¯Ø±Ø³Øª Ø§Ø³Øª â€” Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯', 'error');
        input.value = '';
        drawCaptcha();
      }
    }

    function setMessage(text, type){
      msg.textContent = text;
      msg.style.color = type === 'success' ? 'green' : (type === 'error' ? '#b91c1c' : '#111827');
    }

    // events
    refreshBtn.addEventListener('click', ()=>{ drawCaptcha(); input.value=''; setMessage('', ''); input.focus(); });
    audioBtn.addEventListener('click', ()=>{ readCaptcha(); });
    verifyBtn.addEventListener('click', ()=>{ verify(); });
    cancelBtn.addEventListener('click', ()=>{ setMessage('Ø¹Ù…Ù„ÛŒØ§Øª Ù„ØºÙˆ Ø´Ø¯', ''); input.value=''; });

    input.addEventListener('keydown', (e)=>{ if(e.key === 'Enter') verify(); });

    // initial draw
    drawCaptcha();

    // accessibility helper: hidden label for screen readers
    (function addSR(){
      const style = document.createElement('style');
      style.textContent = '.sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}';
      document.head.appendChild(style);
      const lbl = document.createElement('label');
      lbl.className = 'sr-only';
      lbl.setAttribute('for','captchaInput');
      lbl.textContent = 'Ù…ØªÙ† Ú©Ù¾Ú†Ø§ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯';
      document.querySelector('.card').prepend(lbl);
    })();
  </script>
</body>
</html>